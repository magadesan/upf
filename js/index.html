<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Terminal</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }

    .window {
      position: absolute;
      width: 210px;
      height: 55px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
      cursor: move;
      display: flex;
      flex-direction: column;
    }

    .window-header {
      background-color: #ccc;
      padding: 0.5px;
      text-align: center;
      font-size: 12px;
    }

    .svg-container {
      display: flex;
      gap: 0;
      justify-content: space-between;
      padding: 5px;
    }

    .svg-container object {
      width: 30px;
      height: 45px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/gh/DrGoldfire/Z80.js@master/Z80.js"></script>
  <script src="register.js"></script>
  <script src="run.js"></script>
  <script src="parseIntelHex.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
</head>

<body>
  <div id="terminal"></div>
  <div class="window" id="window">
    <div class="window-header">
      <span>uPf-1</span>
    </div>
    <div class="svg-container">
      <object type="image/svg+xml" id="svg-object-add3" data="./7seg.svg"></object>
      <object type="image/svg+xml" id="svg-object-add2" data="./7seg.svg"></object>
      <object type="image/svg+xml" id="svg-object-add1" data="./7seg.svg"></object>
      <object type="image/svg+xml" id="svg-object-add0" data="./7seg.svg"></object>
      <object type="image/svg+xml" id="svg-object-data1" data="./7seg.svg"></object>
      <object type="image/svg+xml" id="svg-object-data0" data="./7seg.svg"></object>
    </div>
  </div>

  <script>
    // Initialize the terminal
    const term = new Terminal();
    term.open(document.getElementById('terminal'));
    term.write("Welcome to the Interactive CLI!\n\rexit, pc, go, dump, step/s, reg, break\r\n> ");
    let currentCommand = '';
    let breakpoint = 0xffff;

    // Command Execution Handler
    term.onData((data) => {
      if (data === '\r') {
        executeCommand(currentCommand.trim());
        currentCommand = '';
        term.write('\n\r> ');
      } else if (data === '\x7f') {
        currentCommand = currentCommand.slice(0, -1);
        term.write('\b \b');
      } else {
        currentCommand += data;
        term.write(data);
      }
    });

    // Execute Commands
    function executeCommand(command) {
      const [cmd, ...args] = command.split(' ');

      const commands = {
        'exit': () => {
          term.write('\n\rExiting...\n\r');
        },
        'go': () => {
          let num = args.length && !isNaN(Number(args[0])) ? Number(args[0]) : 10;
          term.write('\n\r');
          while (num-- > 0 && zpu.getState().pc !== breakpoint) {
            zpu.run_instruction();
          }
          displayRegisters();
        },
        'pc': () => {
          let num = args.length && !isNaN(Number(args[0])) ? Number(args[0]) : 10;
          term.write('\n\r');
          let state = zpu.getState();
          state.pc = num;
          zpu.getState();
        },
        'break': () => {
          let num = args.length && !isNaN(Number(args[0])) ? Number(args[0]) : 0;
          breakpoint = num;
        },
        'reg': () => {
          term.write('\n\r');
          displayRegisters();
        },
        'set': () => term.write('\nEcho: ' + currentCommand.slice(5).trim()),
        'dump': () => {
          term.write('\n\r');
          let start = args.length && !isNaN(parseInt(args[0], 16)) ? parseInt(args[0], 16) : zpu.getState().pc;
          let end = args.length && !isNaN(parseInt(args[1], 16)) ? parseInt(args[1], 16) : start + 128;
          displayMemorySubset(start, end);
        },
        'step': () => {
          zpu.run_instruction();
        },
        's': () => {
          zpu.run_instruction();
        },
        'default': () => {
          term.write(`\ncommand not found: ${command}`);
        }
      };

      (commands[cmd] || commands['default'])();
    }

    // Dragging functionality for the window
    const windowElement = document.getElementById('window');
    let isDragging = false;
    let initialX, initialY;

    windowElement.addEventListener('mousedown', startDragging);
    windowElement.addEventListener('mouseup', stopDragging);
    windowElement.addEventListener('mousemove', drag);

    function startDragging(e) {
      isDragging = true;
      initialX = e.clientX - windowElement.offsetLeft;
      initialY = e.clientY - windowElement.offsetTop;
    }

    function stopDragging() {
      isDragging = false;
    }

    function drag(e) {
      if (isDragging) {
        windowElement.style.left = `${e.clientX - initialX}px`;
        windowElement.style.top = `${e.clientY - initialY}px`;
      }
    }
  </script>
</body>

</html>
