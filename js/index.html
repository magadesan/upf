<!DOCTYPE html>
<html>

<head>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    .window {
      position: absolute;
      width: 210px;
      height: 55px;
      background-color: #f0f0f0;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
      cursor: move;
    }
  </style>
  <meta charset="utf-8">
  <script src="https://cdn.jsdelivr.net/gh/DrGoldfire/Z80.js@master/Z80.js"></script>
  <script src="register.js"></script>
  <script src="run.js"></script>
  <script src="parseIntelHex.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css" />
</head>

<body>
  <div id="terminal"></div>
  <div class="window" id="window">
    <div class="window-header" style="background-color: #ccc; padding: .5px;">
      <span>uPf-1</span>
    </div>
    <div class="svg-container" style="padding: 0; display: flex; gap: 0;">
      <object type="image/svg+xml" id="svg-object-add3" data="https://upload.wikimedia.org/wikipedia/en/5/5d/Slanted7SegmentDisplayWithDot.svg" style="width: 30px; height: 45px;"></object>
      <object type="image/svg+xml" id="svg-object-add2" data="https://upload.wikimedia.org/wikipedia/en/5/5d/Slanted7SegmentDisplayWithDot.svg" style="width: 30px; height: 45px;"></object>
      <object type="image/svg+xml" id="svg-object-add1" data="https://upload.wikimedia.org/wikipedia/en/5/5d/Slanted7SegmentDisplayWithDot.svg" style="width: 30px; height: 45px;"></object>
      <object type="image/svg+xml" id="svg-object-add0" data="https://upload.wikimedia.org/wikipedia/en/5/5d/Slanted7SegmentDisplayWithDot.svg" style="margin-right: 20px;  width: 30px; height: 45px;"></object>
      <object type="image/svg+xml" id="svg-object-data1" data="https://upload.wikimedia.org/wikipedia/en/5/5d/Slanted7SegmentDisplayWithDot.svg" style="width: 30px; height: 45px;"></object>
      <object type="image/svg+xml" id="svg-object-data0" data="https://upload.wikimedia.org/wikipedia/en/5/5d/Slanted7SegmentDisplayWithDot.svg" style="width: 30px; height: 45px;"></object>
  </div>
  </div>

  <script>
    var term = new Terminal();
    term.open(document.getElementById('terminal'));
    term.write("Welcome to the Interactive CLI!\n\rexit, go, dump, pc, set, read\r\n> ");
    let currentCommand = '';

    // Handle key presses
    term.onData(function (data) {
      if (data === '\r') {
        // Enter key: execute command
        executeCommand(currentCommand);
        currentCommand = '';  // Reset command
        term.write('\n\r> ');   // Display the prompt
      } else if (data === '\x7f') {
        // Backspace key: remove last character
        currentCommand = currentCommand.slice(0, -1);
        term.write('\b \b');
      } else {
        currentCommand += data;
        term.write(data);
      }
    });
    function executeCommand(command) {
      const [cmd, ...args] = command.trim().split(' ');
      switch (cmd) {
        case 'exit':
          term.write('\n\r Exiting...\n\r');
          break;
        case 'go':
          term.write('\n\r');
          let num = 10;
          if (!isNaN(Number(args[0])))
            num = Number(args[0]);
          while (zpu.getState().halted || num-- > 0) {
            zpu.run_instruction();
          }
          displayRegisters();
          break;
        case 'reg':
          term.write('\n\r');
          displayRegisters();
          break;
        case 'set':
          term.write('\nEcho: ' + currentCommand.slice(5).trim());
          break;
        case 'dump':
          term.write('\n\r');
          let start = zpu.getState().pc;
          let end = zpu.getState().pc+128;
          if (!isNaN(Number(parseInt(args[0], 16))))
            start = Number(parseInt(args[0], 16));
          if (!isNaN(Number(parseInt(args[1], 16))))
            end = Number(parseInt(args[1], 16));
          displayMemorySubset(start, end);
          break;
        case 'pc':
          term.write('\nEcho: ' + currentCommand.slice(5).trim());
          break;
        default:
          term.write(`\ncommand not found: ${command}`);
          break;
      }
    }
    const windowElement = document.getElementById('window');
    let isDragging = false;
    let initialX;
    let initialY;

    windowElement.addEventListener('mousedown', startDragging);
    windowElement.addEventListener('mouseup', stopDragging);
    windowElement.addEventListener('mousemove', drag);

    function startDragging(e) {
      isDragging = true;
      initialX = e.clientX - windowElement.getBoundingClientRect().left;
      initialY = e.clientY - windowElement.getBoundingClientRect().top;
    }

    function stopDragging() {
      isDragging = false;
    }

    function drag(e) {
      if (isDragging) {
        const newX = e.clientX - initialX;
        const newY = e.clientY - initialY;
        windowElement.style.left = `${newX}px`;
        windowElement.style.top = `${newY}px`;
      }
    }

  </script>
</body>

</html>